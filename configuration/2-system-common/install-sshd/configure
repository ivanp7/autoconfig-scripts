#!/bin/sh

cd -- "$(dirname -- "$0")"
./check && exit

pacman --needed -S openssh openssh-runit || exit 1

DIALOG_FILE="$(mktemp -p /tmp dialog_file.XXXXXX)" || exit 1
trap 'rm "$DIALOG_FILE"' EXIT

SSH_PORT="$(sed "/^#\?Port /!d; s/.*\s\+//; s/\s\+.*//" /etc/ssh/sshd_config)"

while true
do
    dialog --erase-on-exit --inputbox "Input SSH server port" \
        8 25 "$SSH_PORT" \
        2> "$DIALOG_FILE" || {
        echo "Canceled"
        exit
    }

    SSH_PORT="$(cat -- "$DIALOG_FILE")"
    [ -n "$SSH_PORT" -a "$SSH_PORT" -gt 0 -a "$SSH_PORT" -lt 65536 ] && break || continue
done

sed -i "s/^#\?Port\s\+.*/Port $SSH_PORT/" /etc/ssh/sshd_config
sed -i "s/^#\?PermitRootLogin\s\+.*/PermitRootLogin no/" /etc/ssh/sshd_config
sed -i "s/^#\?PubkeyAuthentication\s\+.*/PubkeyAuthentication yes/" /etc/ssh/sshd_config
sed -i "s/^#\?PasswordAuthentication\s\+.*/PasswordAuthentication no/" /etc/ssh/sshd_config
sed -i "s/^#\?PermitEmptyPasswords\s\+.*/PermitEmptyPasswords no/" /etc/ssh/sshd_config

${EDITOR:-vi} /etc/ssh/sshd_config

ln -s -t /run/runit/service /etc/runit/sv/sshd
sv start sshd

