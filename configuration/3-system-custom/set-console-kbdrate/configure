#!/bin/sh

RATE_VALUES="2.0, 2.1, 2.3, 2.5, 2.7, 3.0, 3.3, 3.7, 4.0, 4.3, 4.6, 5.0, 5.5, 6.0, 6.7, 7.5, 8.0, 8.6, 9.2, 10.0, 10.9, 12.0, 13.3, 15.0, 16.0, 17.1, 18.5, 20.0, 21.8, 24.0, 26.7, 30.0"
DELAY_VALUES="250, 500, 750, 1000"

DIALOG_FILE="$(mktemp -p /tmp dialog_file.XXXXXX)" || exit 1
trap 'rm "$DIALOG_FILE"' EXIT

KBD_RATE="10.0"
KBD_DELAY="250"

while true
do
    dialog --erase-on-exit \
        --keep-window --begin 1 1 --infobox "$(echo \
        "Allowed values for rate (cps): $RATE_VALUES" \
        "\nAllowed values for delay (ms): $DELAY_VALUES")" \
        7 56 \
        --and-widget --form "Input kbdrate values" 9 25 2 \
        "rate (cps)" 1 2 "$KBD_RATE" 1 13 5 4 \
        "delay (ms)" 2 2 "$KBD_DELAY" 2 13 5 4 \
        2> "$DIALOG_FILE" || {
        echo "Canceled"
        exit
    }

    KBD_RATE="$(head -1 -- "$DIALOG_FILE")"
    KBD_DELAY="$(tail -1 -- "$DIALOG_FILE")"

    echo "$KBD_RATE" | grep -xq "[0-9]\+\.[0-9]\+" || continue
    echo "$RATE_VALUES" | grep -Fq "$KBD_RATE" || continue

    echo "$KBD_DELAY" | grep -xq "[0-9]\+" || continue
    echo "$DELAY_VALUES" | grep -Fq "$KBD_DELAY" || continue

    break
done

echo "#!/bin/sh
kbdrate -r $KBD_RATE -d $KBD_DELAY > /dev/null
" > /etc/local.d/set-kbdrate.start
chmod 755 /etc/local.d/set-kbdrate.start

