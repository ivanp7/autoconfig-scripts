#!/bin/sh

cd -- "$(dirname -- "$0")"

DIALOG_FILE="$(mktemp -p /tmp dialog_file.XXXXXX)" || exit 1
trap 'rm "$DIALOG_FILE"' EXIT

VT_WIDTH="$(tput cols)"
VT_HEIGHT="$(tput lines)"

while true
do
    dialog --erase-on-exit --form "Input virtual terminal size" 9 22 2 \
        "width" 1 2 "$VT_WIDTH" 1 10 4 3 \
        "height" 2 2 "$VT_HEIGHT" 2 10 4 3 \
        2> "$DIALOG_FILE" || {
        echo "Canceled"
        exit
    }

    VT_WIDTH="$(head -1 "$DIALOG_FILE")"
    VT_HEIGHT="$(tail -1 "$DIALOG_FILE")"

    [ "$VT_WIDTH" -ge 40 ] || continue
    [ "$VT_HEIGHT" -ge 30 ] || continue

    break
done

LOGO_HALFWIDTH=18
LOGO_HALFHEIGHT=11
PROMPT_HEIGHT=5

install -m 644 "files/issue" /etc/issue || exit 1
sed -i "s/<HORIZONTAL>/$(($VT_WIDTH / 2 - $LOGO_HALFWIDTH))/;
    s/<VERTICAL>/$(($VT_HEIGHT / 2 - $LOGO_HALFHEIGHT - $PROMPT_HEIGHT))/" /etc/issue

